<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JFK Precision Timer</title>
    <style>
        /* --- VARIABLES & THEME --- */
        :root {
            --bg-body: #050505;
            --bg-surface: #121212;
            --border-surface: rgba(255, 255, 255, 0.08);
            
            --text-primary: #ffffff;
            --text-secondary: #888888;
            
            --accent-start: #ff8c42; /* Naranja (Izquierda) */
            --accent-end: #26de81;   /* Verde (Derecha) */
            
            --btn-bg: rgba(255, 255, 255, 0.06);
            --btn-hover: rgba(255, 255, 255, 0.12);
            
            --font-main: 'SF Pro Display', -apple-system, 'Inter', sans-serif;
            --ease-smooth: cubic-bezier(0.25, 1, 0.5, 1);
        }

        [data-theme="light"] {
            --bg-body: #f0f0f2;
            --bg-surface: #ffffff;
            --border-surface: rgba(0, 0, 0, 0.06);
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --btn-bg: rgba(0, 0, 0, 0.05);
            --btn-hover: rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--bg-body);
            color: var(--text-primary);
            font-family: var(--font-main);
            transition: background 0.4s ease;
            overflow: hidden; /* Evita scroll en móvil */
        }

        /* Ruido de fondo sutil para textura premium */
        .noise {
            position: absolute;
            inset: 0;
            opacity: 0.03;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            z-index: 0;
        }

        /* --- CONTENEDOR PRINCIPAL --- */
        .app-card {
            position: relative;
            z-index: 1;
            width: 380px;
            background: var(--bg-surface);
            border: 1px solid var(--border-surface);
            border-radius: 40px;
            padding: 30px;
            box-shadow: 0 40px 80px -20px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            align-items: center;
            transform: translateZ(0);
        }

        /* --- HEADER --- */
        .header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .icon-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .icon-btn:hover { background: var(--btn-bg); color: var(--text-primary); }
        .icon-btn svg { width: 20px; height: 20px; fill: currentColor; }

        .status-pill {
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            padding: 6px 12px;
            background: var(--btn-bg);
            border-radius: 20px;
            color: var(--text-secondary);
        }

        /* --- TABS --- */
        .tabs {
            display: flex;
            background: var(--btn-bg);
            padding: 4px;
            border-radius: 16px;
            margin-bottom: 30px;
            width: 100%;
        }
        
        .tab-btn {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 600;
            padding: 8px;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s var(--ease-smooth);
        }
        
        .tab-btn.active {
            background: var(--bg-surface);
            color: var(--text-primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* --- TIMER VISUAL --- */
        .timer-stage {
            position: relative;
            width: 250px;
            height: 250px;
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        svg.ring {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg); /* Inicio a las 12 en punto */
            overflow: visible;
        }

        circle {
            fill: none;
            stroke-width: 10;
            stroke-linecap: round;
            transform-origin: center;
        }

        .track { stroke: var(--btn-bg); }

        .progress {
            stroke: url(#horizontal-gradient);
            transition: stroke-dashoffset 1s linear;
            filter: drop-shadow(0 0 10px rgba(255, 140, 66, 0.3));
        }

        .time-label {
            position: absolute;
            font-size: 4.5rem;
            font-weight: 700;
            font-feature-settings: "tnum";
            letter-spacing: -2px;
            user-select: none;
        }

        /* --- CONTROLES --- */
        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .action-btn {
            width: 50px;
            height: 50px;
            border-radius: 18px;
            border: 1px solid var(--border-surface);
            background: var(--btn-bg);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
        }
        .action-btn:active { transform: scale(0.95); }
        .action-btn svg { width: 20px; height: 20px; fill: currentColor; }

        .play-btn {
            width: 70px;
            height: 70px;
            border-radius: 24px;
            background: var(--text-primary);
            color: var(--bg-surface);
            font-size: 1.5rem;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px -5px rgba(0,0,0,0.3);
        }
        .play-btn svg { width: 28px; height: 28px; fill: currentColor; }
        .play-btn:active { transform: scale(0.92); }

        /* --- MENÚ DE AJUSTES (Overlay) --- */
        .settings-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-surface);
            border-radius: 40px;
            padding: 30px;
            display: flex;
            flex-direction: column;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            transform: translateY(20px);
            transition: all 0.3s var(--ease-smooth);
        }

        .settings-overlay.visible {
            opacity: 1;
            pointer-events: all;
            transform: translateY(0);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .settings-header h3 { margin: 0; font-size: 1.2rem; }

        .input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-surface);
        }

        .input-row label { font-size: 0.9rem; color: var(--text-secondary); }

        .time-input {
            width: 60px;
            background: var(--btn-bg);
            border: 1px solid var(--border-surface);
            color: var(--text-primary);
            padding: 8px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 1rem;
        }

        /* --- PIP MODE (Estilos Críticos) --- */
        body.in-pip-mode .app-card {
            width: 100vw;
            height: 100vh;
            border: none;
            border-radius: 0;
            box-shadow: none;
            padding: 0;
            justify-content: center;
            background: var(--bg-surface);
        }

        /* Ocultar elementos en PiP */
        body.in-pip-mode .header,
        body.in-pip-mode .tabs,
        body.in-pip-mode .settings-btn-trigger,
        body.in-pip-mode .pip-btn-trigger {
            display: none !important;
        }

        /* Re-escalar elementos en PiP para que ocupen todo */
        body.in-pip-mode .timer-stage {
            width: 60vmin;
            height: 60vmin;
            margin-bottom: 10px;
        }

        body.in-pip-mode .time-label { font-size: 18vmin; }

        body.in-pip-mode .controls { gap: 10px; }
        
        body.in-pip-mode .play-btn {
            width: 15vmin; height: 15vmin;
            min-width: 50px; min-height: 50px;
            border-radius: 30%;
        }
        body.in-pip-mode .play-btn svg { width: 40%; height: 40%; }
        
        body.in-pip-mode .action-btn {
            width: 12vmin; height: 12vmin;
            min-width: 40px; min-height: 40px;
        }

        /* Mensaje de Overlay cuando PiP está activo */
        .pip-active-msg {
            display: none;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        .pip-active-msg p { margin-bottom: 15px; color: var(--text-secondary); }
        .pip-active-msg button {
            background: var(--text-primary); color: var(--bg-surface);
            border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;
        }
        
        body.pip-window-open .app-card { opacity: 0; pointer-events: none; }
        body.pip-window-open .pip-active-msg { display: block; }

    </style>
</head>
<body>

    <div class="noise"></div>

    <div class="pip-active-msg">
        <p>Temporizador minimizado</p>
        <button onclick="window.jfkApp.closePiP()">Traer de vuelta</button>
    </div>

    <div class="app-card" id="main-ui">
        
        <div class="header">
            <button class="icon-btn" id="btn-theme" title="Cambiar Tema">
                <svg viewBox="0 0 24 24"><path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z"/></svg>
            </button>
            <div class="status-pill" id="status-display">FOCUS</div>
            <button class="icon-btn settings-btn-trigger" id="btn-settings" title="Ajustes">
                <svg viewBox="0 0 24 24"><path d="M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"/></svg>
            </button>
        </div>

        <div class="settings-overlay" id="settings-panel">
            <div class="settings-header">
                <h3>Configuración</h3>
                <button class="icon-btn" id="btn-close-settings">✕</button>
            </div>
            <div class="input-row">
                <label>Focus (min)</label>
                <input type="number" id="inp-focus" class="time-input" min="1">
            </div>
            <div class="input-row">
                <label>Short Break (min)</label>
                <input type="number" id="inp-short" class="time-input" min="1">
            </div>
            <div class="input-row">
                <label>Long Break (min)</label>
                <input type="number" id="inp-long" class="time-input" min="1">
            </div>
            <div style="margin-top: auto;">
                <button class="play-btn" style="width:100%; border-radius:12px; font-size:1rem; height:50px;" id="btn-save-settings">Guardar Cambios</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" data-mode="focus">Focus</button>
            <button class="tab-btn" data-mode="short">Short Break</button>
            <button class="tab-btn" data-mode="long">Long Break</button>
        </div>

        <div class="timer-stage">
            <svg class="ring" viewBox="0 0 200 200">
                <defs>
                    <linearGradient id="horizontal-gradient" gradientTransform="rotate(90)">
                        <stop offset="0%" stop-color="#ff8c42" /> <stop offset="100%" stop-color="#26de81" /> </linearGradient>
                </defs>

                <circle class="track" cx="100" cy="100" r="90"></circle>
                <circle class="progress" id="ring-progress" cx="100" cy="100" r="90" 
                        stroke-dasharray="565.48" stroke-dashoffset="0"></circle>
            </svg>
            <div class="time-label" id="timer-display">25:00</div>
        </div>

        <div class="controls">
            <button class="action-btn" id="btn-reset" title="Reiniciar">
                <svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
            </button>
            
            <button class="play-btn" id="btn-toggle">
                <svg id="icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                <svg id="icon-pause" viewBox="0 0 24 24" style="display:none"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
            </button>
            
            <button class="action-btn pip-btn-trigger" id="btn-pip" title="Modo Flotante">
                <svg viewBox="0 0 24 24"><path d="M19 11h-8v6h8v-6zm4 8V4.98C23 3.88 22.1 3 21 3H3c-1.1 0-2 .88-2 1.98V19c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2zm-2 .02H3V4.97h18v14.05z"/></svg>
            </button>
        </div>

    </div>

    <script>
        class PomodoroEngine {
            constructor() {
                // Configuración Base
                this.defaults = { focus: 25, short: 5, long: 15 };
                this.settings = JSON.parse(localStorage.getItem('jfk-settings')) || this.defaults;
                this.theme = localStorage.getItem('jfk-theme') || 'dark';
                
                // Estado
                this.mode = 'focus';
                this.totalTime = this.settings.focus * 60;
                this.timeLeft = this.totalTime;
                this.isRunning = false;
                this.interval = null;
                this.pipWindow = null;

                // Elementos DOM
                this.ui = {
                    body: document.body,
                    app: document.getElementById('main-ui'),
                    timer: document.getElementById('timer-display'),
                    ring: document.getElementById('ring-progress'),
                    status: document.getElementById('status-display'),
                    iconPlay: document.getElementById('icon-play'),
                    iconPause: document.getElementById('icon-pause'),
                    settingsPanel: document.getElementById('settings-panel'),
                    inputs: {
                        focus: document.getElementById('inp-focus'),
                        short: document.getElementById('inp-short'),
                        long: document.getElementById('inp-long')
                    }
                };

                this.init();
            }

            init() {
                this.applyTheme(this.theme);
                this.bindEvents();
                this.updateUI();
                
                // Pre-llenar inputs
                this.ui.inputs.focus.value = this.settings.focus;
                this.ui.inputs.short.value = this.settings.short;
                this.ui.inputs.long.value = this.settings.long;
            }

            bindEvents() {
                // Botones principales
                document.getElementById('btn-toggle').onclick = () => this.toggle();
                document.getElementById('btn-reset').onclick = () => this.reset();
                document.getElementById('btn-theme').onclick = () => this.toggleTheme();
                
                // Settings Logic
                document.getElementById('btn-settings').onclick = () => this.ui.settingsPanel.classList.add('visible');
                document.getElementById('btn-close-settings').onclick = () => this.ui.settingsPanel.classList.remove('visible');
                document.getElementById('btn-save-settings').onclick = () => this.saveSettings();

                // PiP
                document.getElementById('btn-pip').onclick = () => this.openPiP();

                // Tabs
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.onclick = () => this.setMode(btn.dataset.mode);
                });
            }

            toggle() {
                this.isRunning ? this.pause() : this.start();
            }

            start() {
                if (this.isRunning) return;
                this.isRunning = true;
                this.ui.iconPlay.style.display = 'none';
                this.ui.iconPause.style.display = 'block';
                this.playSound('start');

                this.interval = setInterval(() => {
                    if (this.timeLeft > 0) {
                        this.timeLeft--;
                        this.updateUI();
                    } else {
                        this.complete();
                    }
                }, 1000);
            }

            pause() {
                this.isRunning = false;
                clearInterval(this.interval);
                this.ui.iconPlay.style.display = 'block';
                this.ui.iconPause.style.display = 'none';
            }

            reset() {
                this.pause();
                const mins = this.settings[this.mode];
                this.totalTime = mins * 60;
                this.timeLeft = this.totalTime;
                this.updateUI();
            }

            setMode(mode) {
                this.mode = mode;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
                
                this.ui.status.innerText = mode.toUpperCase();
                this.reset();
            }

            complete() {
                this.pause();
                this.playSound('end');
                alert("¡Ciclo Terminado!");
            }

            updateUI() {
                const m = Math.floor(this.timeLeft / 60);
                const s = this.timeLeft % 60;
                const timeStr = `${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
                
                this.ui.timer.innerText = timeStr;
                document.title = `${timeStr} - JFK Timer`;

                // Cálculo del anillo
                // 2 * PI * r(90) = 565.48
                const circumference = 565.48;
                const offset = circumference - (this.timeLeft / this.totalTime) * circumference;
                this.ui.ring.style.strokeDashoffset = offset;
            }

            saveSettings() {
                this.settings = {
                    focus: parseInt(this.ui.inputs.focus.value) || 25,
                    short: parseInt(this.ui.inputs.short.value) || 5,
                    long: parseInt(this.ui.inputs.long.value) || 15
                };
                localStorage.setItem('jfk-settings', JSON.stringify(this.settings));
                this.ui.settingsPanel.classList.remove('visible');
                this.reset(); // Aplica cambios inmediatamente
            }

            toggleTheme() {
                this.theme = this.theme === 'dark' ? 'light' : 'dark';
                localStorage.setItem('jfk-theme', this.theme);
                this.applyTheme(this.theme);
            }

            applyTheme(t) {
                document.documentElement.setAttribute('data-theme', t);
                if(this.pipWindow) this.pipWindow.document.documentElement.setAttribute('data-theme', t);
            }

            playSound(type) {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                const now = ctx.currentTime;
                osc.type = 'sine';
                
                if (type === 'start') {
                    osc.frequency.setValueAtTime(440, now);
                    osc.frequency.exponentialRampToValueAtTime(660, now + 0.1);
                } else {
                    osc.frequency.setValueAtTime(880, now);
                    osc.frequency.exponentialRampToValueAtTime(440, now + 0.3);
                    osc.type = 'square';
                }
                
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.00001, now + 0.5);
                
                osc.start(now);
                osc.stop(now + 0.5);
            }

            // --- Lógica PiP Robusta ---
            async openPiP() {
                if (!window.documentPictureInPicture) return alert("Navegador no compatible (Usa Chrome/Edge).");
                if (this.pipWindow) return;

                const pip = await documentPictureInPicture.requestWindow({ width: 300, height: 300 });
                this.pipWindow = pip;

                // 1. Copiar estilos
                [...document.styleSheets].forEach(sheet => {
                    try {
                        const css = [...sheet.cssRules].map(r => r.cssText).join('');
                        const style = document.createElement('style');
                        style.textContent = css;
                        pip.document.head.appendChild(style);
                    } catch(e) {}
                });

                // 2. Mover la UI
                pip.document.body.className = 'in-pip-mode'; // Clase crítica para estilos
                this.applyTheme(this.theme); // Re-aplicar tema
                pip.document.body.appendChild(this.ui.app);

                // 3. Gestión de estado
                this.ui.body.classList.add('pip-window-open');

                // 4. Retorno al cerrar
                pip.addEventListener('pagehide', () => {
                    this.closePiP();
                });
            }

            closePiP() {
                if (this.pipWindow) {
                    this.pipWindow.close();
                    this.pipWindow = null;
                }
                this.ui.body.classList.remove('pip-window-open');
                this.ui.body.appendChild(this.ui.app);
                // Limpiar clase de PiP
                document.body.className = ''; 
            }
        }

        // Global Instance
        window.onload = () => { window.jfkApp = new PomodoroEngine(); };
    </script>
</body>
</html>
