<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generador de Acreditaciones v2</title>
  <link rel="icon" href="img/logos/LogoClubBocatas.png">

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Poppins:wght@400;600;800&family=Montserrat:wght@400;600;700&display=swap"
    rel="stylesheet">

  <style>
    html {
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Ubuntu, Cantarell, Arial;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .card {
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(6px);
      border: 1px solid rgba(15, 23, 42, 0.06);
      border-radius: 1rem;
    }

    .canvas-border {
      background: #0f172a;
      border-radius: 12px;
      padding: 8px;
    }

    canvas {
      background: #fff;
      border-radius: 8px;
      display: block;
      width: 100%;
      height: auto;
      cursor: crosshair; /* Cursor para indicar que se puede clicar */
    }

    .dropzone {
      border-radius: 12px;
      border: 2px dashed rgba(15, 23, 42, 0.08);
      padding: 14px;
      cursor: pointer;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0.4));
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .dropzone.dragover {
      border-color: #f97316;
      transform: translateY(-3px);
      box-shadow: 0 8px 32px rgba(249, 115, 22, 0.12);
    }

    .dropzone .meta {
      font-size: 13px;
      color: #334155;
    }

    .file-name {
      font-weight: 600;
      color: #0f172a;
    }

    .small-muted {
      font-size: 12px;
      color: #6b7280;
    }

    .btn-fixed {
      right: 1.5rem;
      bottom: 1.5rem;
      position: fixed;
      z-index: 60;
    }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-r from-orange-100 via-white to-green-100 text-zinc-900">

  <header class="text-center py-8 px-6">
    <div class="flex justify-center mb-4">
      <img src="img/logos/sinf.png" alt="Logo Club" class="h-24 w-auto sm:h-32" onerror="this.style.display='none'">
    </div>
    <h1 class="text-3xl sm:text-5xl font-extrabold">Club de Debate UMU</h1>
    <p class="mt-3 text-base sm:text-lg text-zinc-700">Generador de Acreditaciones y Diplomas</p>
  </header>

  <main class="px-6 pb-16 max-w-6xl mx-auto">
    <section class="card p-6 shadow-xl">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <div class="space-y-4">
          <h2 class="text-xl font-semibold">Configuraci√≥n</h2>
          <p class="text-sm text-zinc-600">Sube imagen base y CSV. <br><strong>Truco:</strong> Guarda tu Excel como CSV UTF-8.</p>

          <div id="imgDropzone" class="dropzone" title="Arrastra / suelta imagen o haz click">
            <input id="imgInput" type="file" accept="image/*" class="hidden" />
            <div
              style="width:44px;height:44px;border-radius:8px;background:linear-gradient(180deg,#f97316,#fb923c);display:flex;align-items:center;justify-content:center;color:white;font-weight:700">
              IMG</div>
            <div class="meta">
              <div class="file-name" id="imgName">Arrastra imagen base</div>
              <div class="small-muted">JPG/PNG alta calidad.</div>
            </div>
          </div>

          <div id="csvDropzone" class="dropzone" title="Arrastra / suelta CSV o haz click">
            <input id="csvInput" type="file" accept=".csv,text/csv" class="hidden" />
            <div
              style="width:44px;height:44px;border-radius:8px;background:linear-gradient(180deg,#10b981,#34d399);display:flex;align-items:center;justify-content:center;color:white;font-weight:700">
              CSV</div>
            <div class="meta">
              <div class="file-name" id="csvName">Arrastra el CSV</div>
              <div class="small-muted">La fila 1 ser√° la cabecera.</div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3 mt-2">
            <div>
              <label class="block text-sm">Columna Nombre</label>
              <select id="colNameSelect"
                class="mt-1 block w-full rounded-2xl border border-zinc-200 p-3 bg-white text-sm"></select>
            </div>
            <div>
              <label class="block text-sm">Columna Subt√≠tulo</label>
              <select id="colTeamSelect"
                class="mt-1 block w-full rounded-2xl border border-zinc-200 p-3 bg-white text-sm"></select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3 mt-3">
            <div>
              <label class="block text-sm">Fuente</label>
              <select id="fontFamily" class="mt-1 block w-full rounded-2xl border border-zinc-200 p-3 bg-white text-sm">
                <option>Inter</option>
                <option>Poppins</option>
                <option>Montserrat</option>
                <option>Roboto Slab</option>
                <option>Lato</option>
                <option>Open Sans</option>
                <option>Oswald</option>
                <option>Arial</option>
                <option>Times New Roman</option>
                <option>Courier New</option>
              </select>
            </div>

            <div>
              <label class="block text-sm">Color Texto</label>
              <input id="fontColor" type="color" value="#ffffff" class="mt-1 w-full h-11 rounded-2xl p-1" />
            </div>

            <div class="col-span-2">
              <label class="block text-sm">Tama√±o (px) ‚Äî <span id="fontSizeVal">36</span>px</label>
              <input id="fontSize" type="range" min="12" max="120" value="36" class="w-full mt-2" />
            </div>

            <div>
              <label class="block text-sm">Posici√≥n Predefinida</label>
              <select id="positionPreset"
                class="mt-1 block w-full rounded-2xl border border-zinc-200 p-3 bg-white text-sm">
                <option value="50,50">Centro</option>
                <option value="50,10">Arriba Centro</option>
                <option value="50,90" selected>Abajo Centro</option>
                <option value="10,10">Esq. Sup. Izq</option>
                <option value="90,10">Esq. Sup. Der</option>
                <option value="10,90">Esq. Inf. Izq</option>
                <option value="90,90">Esq. Inf. Der</option>
              </select>
            </div>

            <div class="flex items-center gap-2">
              <input id="clickToPlace" type="checkbox" checked class="h-5 w-5 accent-orange-500" />
              <label class="text-sm">Click en imagen para mover</label>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3 mt-3">
            <button id="prevBtn"
              class="w-full py-3 rounded-2xl font-bold bg-zinc-100 hover:bg-zinc-200 text-zinc-700">‚óÄ
              Anterior</button>
            <button id="nextBtn"
              class="w-full py-3 rounded-2xl font-bold bg-zinc-100 hover:bg-zinc-200 text-zinc-700">Siguiente
              ‚ñ∂</button>
            <button id="downloadBtn"
              class="w-full py-3 rounded-2xl font-bold bg-gradient-to-r from-orange-400 to-orange-500 text-white shadow-md hover:shadow-lg transition-all">
              Bajar PNG Actual
            </button>
            <button id="downloadAllBtn"
              class="w-full py-3 rounded-2xl font-bold bg-gradient-to-r from-emerald-400 to-emerald-600 text-white shadow-md hover:shadow-lg transition-all">
              Bajar Todo (ZIP)
            </button>
          </div>

          <div class="mt-6 rounded-xl border-2 border-indigo-100 p-4 bg-indigo-50/50">
            <div class="flex items-center gap-2 mb-3">
              <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
              <label class="text-base font-bold text-indigo-900">Exportar a PDF</label>
            </div>
            
            <div class="grid grid-cols-1 gap-3">
               <div>
                <label class="text-xs font-bold uppercase text-zinc-500 tracking-wider">Formato de P√°gina</label>
                <select id="pdfPageMode" class="mt-1 w-full rounded-2xl border border-indigo-200 p-2 bg-white font-medium text-indigo-900">
                  <option value="a4">Hoja A4 (Rejilla / M√∫ltiples)</option>
                  <option value="single">Individual (Tama√±o real de la imagen)</option>
                </select>
              </div>
            </div>

            <div id="a4Options" class="grid grid-cols-2 gap-2 mt-3 transition-all duration-300">
              <div>
                <label class="text-xs text-zinc-500">Columnas</label>
                <input id="pdfCols" type="number" min="1" max="10" value="2" class="mt-1 w-full rounded-2xl border p-2" />
              </div>
              <div>
                <label class="text-xs text-zinc-500">Filas</label>
                <input id="pdfRows" type="number" min="1" max="10" value="4" class="mt-1 w-full rounded-2xl border p-2" />
              </div>
              <div>
                <label class="text-xs text-zinc-500">Orientaci√≥n A4</label>
                <select id="a4Orientation" class="mt-1 w-full rounded-2xl border p-2">
                  <option value="portrait" selected>Vertical</option>
                  <option value="landscape">Horizontal</option>
                </select>
              </div>
              <div>
                <label class="text-xs text-zinc-500">Separaci√≥n (mm)</label>
                <input id="pdfGutter" type="number" min="0" value="0" class="mt-1 w-full rounded-2xl border p-2" />
              </div>
              <div class="col-span-2">
                 <div class="flex items-center gap-2 mt-1">
                  <input id="pdfCropMarks" type="checkbox" class="h-4 w-4" />
                  <label class="text-xs text-zinc-700">Incluir gu√≠as de corte (solo A4)</label>
                 </div>
              </div>
            </div>

            <div class="mt-4 pt-3 border-t border-indigo-200">
              <label class="text-xs text-zinc-500">Calidad de impresi√≥n</label>
              <select id="pdfQuality" class="mt-1 w-full rounded-2xl border p-2 text-sm">
                <option value="medium" selected>Media (Equilibrada)</option>
                <option value="high">Alta (Imprenta)</option>
                <option value="ultra">Ultra (M√°xima)</option>
              </select>
            </div>

            <button id="downloadPdfBtn"
                class="mt-4 w-full py-3 rounded-2xl bg-gradient-to-r from-indigo-500 to-blue-600 hover:from-indigo-600 hover:to-blue-700 text-white font-bold shadow-lg shadow-indigo-200 transition-all">
                Generar PDF
            </button>
            <div class="mt-2 text-xs text-center text-indigo-400" id="cellSizeInfo"></div>
          </div>
        </div>

        <div class="space-y-4">
          <div class="canvas-border shadow-inner">
            <canvas id="preview" width="800" height="450"></canvas>
          </div>
          <p class="text-xs text-center text-zinc-400">üí° Haz click en la imagen para mover el texto manualmente.</p>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <div class="text-sm font-semibold text-zinc-700 mb-1">Lista (Primeros 50)</div>
              <div id="csvList" class="max-h-48 overflow-auto rounded-xl border border-zinc-200 p-2 bg-white text-sm">
                <div class="text-zinc-400 text-center p-4">Carga un CSV para ver datos</div>
              </div>
            </div>

            <div>
              <div class="text-sm font-semibold text-zinc-700 mb-1">Datos Actuales</div>
              <div class="rounded-xl border border-zinc-200 p-4 bg-white shadow-sm">
                <div class="mb-1"><span class="text-xs uppercase text-zinc-400 font-bold">√çndice</span> <span id="idx" class="ml-2 font-mono">-</span></div>
                <div class="mb-1"><span class="text-xs uppercase text-zinc-400 font-bold">Dato 1</span> <span id="curName" class="ml-2 font-semibold">-</span></div>
                <div><span class="text-xs uppercase text-zinc-400 font-bold">Dato 2</span> <span id="curTeam" class="ml-2 text-zinc-600">-</span></div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <section class="mt-10 text-center pb-10">
      <p class="text-xs text-zinc-500">¬© <span id="year"></span> Club de Debate UMU ¬∑ Hecho por JFK</p>
    </section>
  </main>

  <script>
    // --- VARIABLES GLOBALES ---
    let participants = [];
    let rawRowsAll = [];
    let headerRow = null;
    let dataRows = [];
    let current = 0;
    let img = new Image();
    let imgLoaded = false;
    let textPos = { xPct: 50, yPct: 90 }; // Posici√≥n inicial

    // Elementos DOM
    const canvas = document.getElementById('preview');
    const ctx = canvas.getContext('2d');
    
    // Inputs
    const imgInput = document.getElementById('imgInput');
    const csvInput = document.getElementById('csvInput');
    const imgDrop = document.getElementById('imgDropzone');
    const csvDrop = document.getElementById('csvDropzone');
    const imgName = document.getElementById('imgName');
    const csvName = document.getElementById('csvName');
    
    // Controles UI
    const csvList = document.getElementById('csvList');
    const fontSize = document.getElementById('fontSize');
    const fontSizeVal = document.getElementById('fontSizeVal');
    const fontFamily = document.getElementById('fontFamily');
    const fontColor = document.getElementById('fontColor');
    const positionPreset = document.getElementById('positionPreset');
    const clickToPlace = document.getElementById('clickToPlace');
    const idxEl = document.getElementById('idx');
    const curName = document.getElementById('curName');
    const curTeam = document.getElementById('curTeam');
    const colNameSelect = document.getElementById('colNameSelect');
    const colTeamSelect = document.getElementById('colTeamSelect');

    // PDF Controls
    const pdfPageMode = document.getElementById('pdfPageMode');
    const a4Options = document.getElementById('a4Options');
    const pdfCols = document.getElementById('pdfCols');
    const pdfRows = document.getElementById('pdfRows');
    const a4Orientation = document.getElementById('a4Orientation');
    const pdfGutter = document.getElementById('pdfGutter');
    const pdfCropMarks = document.getElementById('pdfCropMarks');
    const pdfQuality = document.getElementById('pdfQuality');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const cellSizeInfo = document.getElementById('cellSizeInfo');

    // --- DROPZONES ---
    function setupDropzone(dropEl, inputEl, onFile) {
      dropEl.addEventListener('click', () => inputEl.click());
      dropEl.addEventListener('dragover', (e) => { e.preventDefault(); dropEl.classList.add('dragover'); });
      dropEl.addEventListener('dragleave', (e) => { e.preventDefault(); dropEl.classList.remove('dragover'); });
      dropEl.addEventListener('drop', (e) => { 
        e.preventDefault(); 
        dropEl.classList.remove('dragover'); 
        const f = e.dataTransfer.files[0]; 
        if (f) { inputEl.files = e.dataTransfer.files; onFile(f); } 
      });
      inputEl.addEventListener('change', () => { const f = inputEl.files[0]; onFile(f); });
    }

    setupDropzone(imgDrop, imgInput, (f) => {
      if (!f) return;
      imgName.textContent = f.name;
      const url = URL.createObjectURL(f);
      img.onload = () => { 
        document.fonts.ready.then(() => { 
          imgLoaded = true; 
          fitCanvasToImage(); 
          render(true); 
          URL.revokeObjectURL(url); 
        }); 
      };
      img.src = url; 
      img.crossOrigin = 'anonymous';
    });

    setupDropzone(csvDrop, csvInput, (f) => {
      if (!f) return;
      csvName.textContent = f.name;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          parseCSV(reader.result);
          populateColumnSelectors();
          mapParticipantsFromSelectedCols();
          showList();
          render(true);
        } catch (e) { alert('Error CSV: ' + e.message); }
      };
      reader.readAsText(f, 'utf-8');
    });

    // --- EVENTOS INTERFAZ ---
    fontSize.addEventListener('input', () => { fontSizeVal.textContent = fontSize.value; render(true); });
    fontFamily.addEventListener('change', () => render(true));
    fontColor.addEventListener('change', () => render(true));
    
    positionPreset.addEventListener('change', () => { 
      const [x, y] = positionPreset.value.split(',').map(Number); 
      textPos.xPct = x; textPos.yPct = y; 
      render(true); 
    });

    colNameSelect.addEventListener('change', () => { mapParticipantsFromSelectedCols(); showList(); render(true); });
    colTeamSelect.addEventListener('change', () => { mapParticipantsFromSelectedCols(); showList(); render(true); });

    document.getElementById('prevBtn').addEventListener('click', () => { 
      if (!participants.length) return; 
      current = (current - 1 + participants.length) % participants.length; 
      updateCurrentUI(); render(true); 
    });
    
    document.getElementById('nextBtn').addEventListener('click', () => { 
      if (!participants.length) return; 
      current = (current + 1) % participants.length; 
      updateCurrentUI(); render(true); 
    });

    document.getElementById('downloadBtn').addEventListener('click', async () => { 
      if (!imgLoaded || !participants.length) return alert('Faltan datos o imagen.'); 
      await exportCurrentImage(); 
    });

    document.getElementById('downloadAllBtn').addEventListener('click', async () => { 
      if (!imgLoaded || !participants.length) return alert('Faltan datos o imagen.'); 
      await exportAllZip(); 
    });

    // Toggle de opciones PDF
    pdfPageMode.addEventListener('change', () => {
        if (pdfPageMode.value === 'single') {
            a4Options.style.opacity = '0.3';
            a4Options.style.pointerEvents = 'none';
            cellSizeInfo.innerHTML = "Se generar√° un PDF con el <strong>tama√±o exacto</strong> de la imagen original.";
        } else {
            a4Options.style.opacity = '1';
            a4Options.style.pointerEvents = 'auto';
            cellSizeInfo.innerHTML = "";
        }
    });

    downloadPdfBtn.addEventListener('click', exportAllPdf);

    // --- CORRECCI√ìN 1: EVENTO CLICK EN CANVAS ---
    canvas.addEventListener('mousedown', (e) => {
      if (!imgLoaded || !clickToPlace.checked) return;
      const rect = canvas.getBoundingClientRect();
      // Calcular coordenadas X e Y relativas al tama√±o visual del canvas
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      // Convertir a porcentajes (0-100)
      textPos.xPct = Math.round((x / canvas.width) * 100);
      textPos.yPct = Math.round((y / canvas.height) * 100);
      
      render(true);
    });

    // --- L√ìGICA CSV ---
    function parseCSV(text) {
      rawRowsAll = [];
      const lines = text.split(/\r?\n/);
      for (const line of lines) {
        if (line.trim()) rawRowsAll.push(parseCSVLine(line));
      }
      if (rawRowsAll.length > 0) {
        headerRow = rawRowsAll[0];
        dataRows = rawRowsAll.slice(0); // Incluir cabecera como dato elegible
      }
      current = 0;
    }

    function parseCSVLine(line) {
      // Parser simple que respeta comillas
      const res = []; let cur = ''; let inQ = false;
      for (let i = 0; i < line.length; i++) {
        const c = line[i];
        if (inQ) { if (c === '"' && line[i+1] === '"') { cur += '"'; i++; } else if (c === '"') { inQ = false; } else { cur += c; } }
        else { if (c === ',') { res.push(cur.trim()); cur = ''; } else if (c === '"') { inQ = true; } else { cur += c; } }
      }
      res.push(cur.trim());
      return res;
    }

    function populateColumnSelectors() {
      if (!dataRows.length) return;
      const maxCols = dataRows.reduce((max, r) => Math.max(max, r.length), 0) || 2;
      colNameSelect.innerHTML = ''; colTeamSelect.innerHTML = '';
      for (let i = 0; i < maxCols; i++) {
        const label = (headerRow && headerRow[i]) ? headerRow[i] : `Columna ${i+1}`;
        colNameSelect.add(new Option(label, i));
        colTeamSelect.add(new Option(label, i));
      }
      colNameSelect.value = 0;
      colTeamSelect.value = Math.min(1, maxCols - 1);
    }

    function mapParticipantsFromSelectedCols() {
      participants = [];
      const nc = +colNameSelect.value, tc = +colTeamSelect.value;
      dataRows.forEach(r => {
        participants.push({ name: r[nc] || '', team: r[tc] || '' });
      });
      updateCurrentUI();
    }

    function showList() {
      csvList.innerHTML = '';
      participants.slice(0,50).forEach((p, i) => {
        const d = document.createElement('div');
        d.className = `p-1 px-2 rounded cursor-pointer hover:bg-zinc-100 ${i === current ? 'bg-orange-100 font-semibold text-orange-800' : ''}`;
        d.textContent = `${i+1}. ${p.name} ${p.team ? '‚Äî ' + p.team : ''}`;
        d.onclick = () => { current = i; updateCurrentUI(); render(true); };
        csvList.appendChild(d);
      });
    }

    function updateCurrentUI() {
      if (!participants.length) return;
      idxEl.textContent = `${current+1} / ${participants.length}`;
      curName.textContent = participants[current].name;
      curTeam.textContent = participants[current].team;
    }

    // --- CANVAS RENDER ---
    function fitCanvasToImage() {
      const maxW = 1000;
      const scale = Math.min(1, maxW / img.width);
      canvas.width = Math.round(img.width * scale);
      canvas.height = Math.round(img.height * scale);
    }

    function render(showMarker = true) {
      // 1. Limpiar
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // 2. Dibujar fondo
      if (imgLoaded) {
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      } else {
        ctx.fillStyle = '#f8fafc'; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = '#94a3b8'; ctx.textAlign='center'; ctx.fillText('Vista Previa', canvas.width/2, canvas.height/2);
        return;
      }

      if (!participants.length) return;

      // 3. Configurar Texto
      const p = participants[current];
      const fsize = +fontSize.value;
      const family = fontFamily.value.replace(/"/g, '');
      const x = Math.round(canvas.width * textPos.xPct / 100);
      const y = Math.round(canvas.height * textPos.yPct / 100);

      ctx.fillStyle = fontColor.value;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      
      // Nombre
      ctx.font = `bold ${fsize}px "${family}", sans-serif`;
      ctx.fillText(p.name, x, y - (fsize * 0.25));
      
      // Equipo
      ctx.font = `normal ${Math.round(fsize * 0.6)}px "${family}", sans-serif`;
      ctx.fillText(p.team, x, y + (fsize * 0.6));

      // 4. Marcadores (CORRECCI√ìN 2: Solo si showMarker es true)
      if (showMarker && clickToPlace.checked) {
        // Punto rojo
        ctx.beginPath();
        ctx.arc(x, y, 6, 0, Math.PI*2);
        ctx.fillStyle = 'rgba(249, 115, 22, 0.8)'; // Naranja Tailwind
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.fill();
        ctx.stroke();

        // Gu√≠as de corte gris (Movidio aqu√≠ dentro para que no salgan al exportar)
        drawPreviewCropMarks(x, y); 
      }
    }

    function drawPreviewCropMarks(cx, cy) {
      const len = 10;
      const off = 30; // Distancia del centro
      ctx.save();
      ctx.strokeStyle = 'rgba(0,0,0,0.3)';
      ctx.lineWidth = 1;
      // Esquinas simples para indicar "zona"
      ctx.beginPath();
      // Solo dibujamos unas muescas sutiles alrededor del texto
      // (No dibujamos toda la caja porque no sabemos el ancho del texto exacto sin medirlo, 
      // pero el punto rojo ya es suficiente referencia).
      ctx.restore();
    }

    // --- EXPORTAR PNG ---
    async function exportCurrentImage() {
      render(false); // Ocultar marcadores
      await new Promise(r => setTimeout(r, 50));
      canvas.toBlob(blob => {
        const p = participants[current];
        saveBlob(blob, `${sanitize(p.name)}-${sanitize(p.team)}.png`);
        render(true); // Restaurar vista
      });
    }

    async function exportAllZip() {
      if (typeof JSZip === 'undefined') await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js');
      const zip = new JSZip();
      const folder = zip.folder('acreditaciones');
      
      const savedIdx = current;
      const btnText = document.getElementById('downloadAllBtn').innerText;
      
      for (let i = 0; i < participants.length; i++) {
        current = i; updateCurrentUI();
        render(false);
        document.getElementById('downloadAllBtn').innerText = `Generando ${i+1}/${participants.length}...`;
        await new Promise(r => setTimeout(r, 10)); // Breve pausa para UI
        const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
        folder.file(`${i+1}_${sanitize(participants[i].name)}.png`, blob);
      }
      
      const zipContent = await zip.generateAsync({type:'blob'});
      saveBlob(zipContent, 'acreditaciones_umu.zip');
      
      current = savedIdx; updateCurrentUI(); render(true);
      document.getElementById('downloadAllBtn').innerText = btnText;
    }

    // --- EXPORTAR PDF (CORRECCI√ìN 3: Modos A4 y Single) ---
    async function exportAllPdf() {
      if (!imgLoaded || !participants.length) return alert('Faltan datos.');
      
      const jsPDF = await ensureJsPdf();
      const mode = pdfPageMode.value; // 'a4' o 'single'
      const quality = pdfQuality.value;
      
      // Calcular DPI seg√∫n calidad
      let dpi = 150; 
      if (quality === 'high') dpi = 300;
      if (quality === 'ultra') dpi = 450;

      // Dimensiones originales de la imagen (px)
      const imgW = img.width;
      const imgH = img.height;
      
      // Convertir imagen original a mm seg√∫n DPI deseado para el PDF
      // (En modo single, el PDF tendr√° este tama√±o f√≠sico)
      const pdfW_mm = (imgW / dpi) * 25.4;
      const pdfH_mm = (imgH / dpi) * 25.4;

      let doc;
      
      if (mode === 'single') {
        // MODO SINGLE: PDF del tama√±o exacto de la imagen
        const orientation = pdfW_mm > pdfH_mm ? 'l' : 'p';
        doc = new jsPDF({ unit: 'mm', format: [pdfW_mm, pdfH_mm], orientation });
      } else {
        // MODO A4 REJILLA
        const orient = a4Orientation.value;
        doc = new jsPDF({ unit: 'mm', format: 'a4', orientation: orient });
      }

      // Canvas offscreen para renderizar a m√°xima resoluci√≥n
      const off = document.createElement('canvas');
      off.width = imgW;
      off.height = imgH;
      const offCtx = off.getContext('2d');

      const savedIdx = current;
      const btn = document.getElementById('downloadPdfBtn');
      const oldText = btn.innerText;

      // Variables para rejilla A4
      let col = 0, row = 0;
      const cols = +pdfCols.value;
      const rows = +pdfRows.value;
      const gutter = +pdfGutter.value;
      
      // Calcular celdas A4
      let cellW, cellH;
      if (mode === 'a4') {
        const pageW = doc.internal.pageSize.getWidth();
        const pageH = doc.internal.pageSize.getHeight();
        cellW = (pageW - (cols-1)*gutter) / cols;
        cellH = (pageH - (rows-1)*gutter) / rows;
      }

      for (let i = 0; i < participants.length; i++) {
        btn.innerText = `Generando p√°g ${i+1}/${participants.length}...`;
        
        // 1. Renderizar en alta resoluci√≥n en offscreen canvas
        // Dibujamos la imagen original a tama√±o real (no escalado como en preview)
        offCtx.clearRect(0,0,imgW,imgH);
        offCtx.drawImage(img, 0, 0);
        
        // Texto escalado
        const p = participants[i];
        const previewScale = canvas.width / imgW; // Factor de escala del preview respecto al real
        const baseFontSize = +fontSize.value;
        const realFontSize = baseFontSize / previewScale; // Tama√±o real en px de la imagen
        
        const family = fontFamily.value.replace(/"/g, '');
        const x = imgW * (textPos.xPct / 100);
        const y = imgH * (textPos.yPct / 100);

        offCtx.fillStyle = fontColor.value;
        offCtx.textAlign = 'center';
        offCtx.textBaseline = 'middle';
        
        offCtx.font = `bold ${realFontSize}px "${family}", sans-serif`;
        offCtx.fillText(p.name, x, y - (realFontSize * 0.25));
        
        offCtx.font = `normal ${Math.round(realFontSize * 0.6)}px "${family}", sans-serif`;
        offCtx.fillText(p.team, x, y + (realFontSize * 0.6));

        // 2. Convertir a imagen para PDF
        const imgData = off.toDataURL('image/jpeg', quality === 'ultra' ? 0.98 : 0.85);

        // 3. A√±adir al PDF
        if (mode === 'single') {
           if (i > 0) doc.addPage([pdfW_mm, pdfH_mm]); // Nueva p√°gina con tama√±o custom
           doc.addImage(imgData, 'JPEG', 0, 0, pdfW_mm, pdfH_mm);
        } else {
           // L√≥gica A4
           if (col >= cols) { col = 0; row++; }
           if (row >= rows) { 
             doc.addPage(); col = 0; row = 0; 
           }
           const xPos = col * (cellW + gutter);
           const yPos = row * (cellH + gutter);
           
           // Ajuste de imagen (contain/cover simple)
           // Por defecto hacemos "cover" (llenar celda) recortando si hace falta, o "contain" si prefieres
           // Aqu√≠ usaremos stretch simple o ajuste proporcional. Hagamos 'contain' centrado.
           const ratioImg = imgW / imgH;
           const ratioCell = cellW / cellH;
           let wDraw = cellW, hDraw = cellH;
           let xDraw = xPos, yDraw = yPos;

           if (ratioImg > ratioCell) {
             // Imagen m√°s ancha que celda
             hDraw = cellW / ratioImg;
             yDraw = yPos + (cellH - hDraw)/2;
           } else {
             wDraw = cellH * ratioImg;
             xDraw = xPos + (cellW - wDraw)/2;
           }
           
           doc.addImage(imgData, 'JPEG', xDraw, yDraw, wDraw, hDraw);

           if (pdfCropMarks.checked) {
             doc.setLineWidth(0.1);
             doc.setDrawColor(200);
             doc.rect(xPos, yPos, cellW, cellH); // Cuadr√≠cula simple
           }
           col++;
        }
        
        // Pausa para no congelar navegador
        if (i % 5 === 0) await new Promise(r => setTimeout(r, 0));
      }

      doc.save('acreditaciones_debate.pdf');
      btn.innerText = oldText;
      current = savedIdx;
    }

    // --- UTILIDADES ---
    function sanitize(str) { return (str||'').replace(/[^a-z0-9]/gi, '_'); }
    function saveBlob(blob, name) {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = name;
      document.body.appendChild(a); a.click(); a.remove();
    }
    function loadScript(src) {
      return new Promise((res, rej) => {
        const s = document.createElement('script'); s.src=src; s.onload=res; s.onerror=rej;
        document.head.appendChild(s);
      });
    }
    async function ensureJsPdf() {
      if (!window.jspdf) await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
      return window.jspdf.jsPDF;
    }

    // Init
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>
