<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generador — Club de Debate UMU</title>
  <link rel="icon" href="img/sinf.png">
  <meta name="description" content="Generador de imágenes con nombres para el Club de Debate UMU" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fuentes (más opciones añadidas) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Poppins:wght@400;600;800&family=Montserrat:wght@400;600;700&family=Roboto+Slab:wght@400;600&family=Lato:wght@400;700&family=Open+Sans:wght@400;600&family=Oswald:wght@400;600&display=swap" rel="stylesheet">

  <style>
    html { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Ubuntu, Cantarell, Arial; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .card { background: rgba(255,255,255,0.92); backdrop-filter: blur(6px); border: 1px solid rgba(15,23,42,0.06); border-radius: 1rem; }
    .canvas-border{ background:#0f172a; border-radius:12px; padding:8px; }
    canvas{ background:#fff; border-radius:8px; display:block; width:100%; height:auto; }
    .dropzone {
      border-radius: 12px;
      border: 2px dashed rgba(15,23,42,0.08);
      padding: 14px;
      cursor: pointer;
      background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.4));
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .dropzone.dragover { border-color: #f97316; transform: translateY(-3px); box-shadow: 0 8px 32px rgba(249,115,22,0.12); }
    .dropzone .meta { font-size: 13px; color: #334155; }
    .file-name { font-weight: 600; color: #0f172a; }
    .small-muted { font-size:12px; color:#6b7280; }
    .btn-fixed { right:1.5rem; bottom:1.5rem; position:fixed; z-index:60; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-r from-orange-100 via-white to-green-100 text-zinc-900">

  <!-- Header: ruta relativa al logo -->
  <header class="text-center py-8 px-6">
    <div class="flex justify-center mb-4">
      <img src="img/sinf.png" alt="Logo Club de Debate UMU" class="h-24 w-auto sm:h-32">
    </div>
    <h1 class="text-3xl sm:text-5xl font-extrabold">Club de Debate UMU</h1>
    <p class="mt-3 text-base sm:text-lg text-zinc-700">Formamos en argumentación, oratoria y debate. Construimos pensamiento crítico.</p>
  </header>

  <!-- Contenedor principal -->
  <main class="px-6 pb-16 max-w-6xl mx-auto">
    <section class="card p-6 shadow-xl">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- Controles (izquierda) -->
        <div class="space-y-4">
          <h2 class="text-xl font-semibold">Generador de imágenes (CSV)</h2>
          <p class="text-sm text-zinc-600">Sube una imagen base y un CSV con líneas como <code>Nombre ; Institución</code>. Arrastra o haz click en los recuadros.</p>

          <!-- Dropzone imagen -->
          <div id="imgDropzone" class="dropzone" title="Arrastra / suelta imagen o haz click">
            <input id="imgInput" type="file" accept="image/*" class="hidden" />
            <div style="width:44px;height:44px;border-radius:8px;background:linear-gradient(180deg,#f97316,#fb923c);display:flex;align-items:center;justify-content:center;color:white;font-weight:700">IMG</div>
            <div class="meta">
              <div class="file-name" id="imgName">Arrastra una imagen o haz click</div>
              <div class="small-muted">JPG, PNG — mejor >=1200px de ancho</div>
            </div>
          </div>

          <!-- Dropzone CSV -->
          <div id="csvDropzone" class="dropzone" title="Arrastra / suelta CSV o haz click">
            <input id="csvInput" type="file" accept=".csv,text/csv" class="hidden" />
            <div style="width:44px;height:44px;border-radius:8px;background:linear-gradient(180deg,#10b981,#34d399);display:flex;align-items:center;justify-content:center;color:white;font-weight:700">CSV</div>
            <div class="meta">
              <div class="file-name" id="csvName">Arrastra el CSV o haz click</div>
              <div class="small-muted">Formato: <code>Nombre ; Institución</code> — UTF-8</div>
            </div>
          </div>

          <!-- Opciones de texto -->
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm">Fuente</label>
              <select id="fontFamily" class="mt-1 block w-full rounded-2xl border border-zinc-200 p-3 bg-white text-sm">
                <option>Inter</option>
                <option>Poppins</option>
                <option>Montserrat</option>
                <option>Roboto Slab</option>
                <option>Lato</option>
                <option>Open Sans</option>
                <option>Oswald</option>
                <option>Arial</option>
                <option>Verdana</option>
                <option>Times New Roman</option>
                <option>Georgia</option>
                <option>Courier New</option>
              </select>
            </div>

            <div>
              <label class="block text-sm">Color</label>
              <input id="fontColor" type="color" value="#ffffff" class="mt-1 w-full h-11 rounded-2xl p-1" />
            </div>

            <div class="col-span-2">
              <label class="block text-sm">Tamaño (px) — <span id="fontSizeVal">36</span>px</label>
              <input id="fontSize" type="range" min="12" max="120" value="36" class="w-full mt-2" />
            </div>

            <div>
              <label class="block text-sm">Posición (presets)</label>
              <select id="positionPreset" class="mt-1 block w-full rounded-2xl border border-zinc-200 p-3 bg-white text-sm">
                <option value="10,10">Arriba izquierda</option>
                <option value="50,10">Arriba centro</option>
                <option value="90,10">Arriba derecha</option>
                <option value="50,50">Centro</option>
                <option value="10,90">Abajo izquierda</option>
                <option value="50,90">Abajo centro</option>
                <option value="90,90">Abajo derecha</option>
              </select>
            </div>

            <div class="flex items-center gap-2">
              <input id="clickToPlace" type="checkbox" checked class="h-5 w-5" />
              <label class="text-sm">Click en canvas para posicionar</label>
            </div>
          </div>

          <!-- Botones -->
          <div class="grid grid-cols-2 gap-3 mt-3">
            <button id="prevBtn" class="w-full py-3 rounded-2xl font-bold bg-gradient-to-r from-orange-400 to-orange-500 text-white">◀ Anterior</button>
            <button id="nextBtn" class="w-full py-3 rounded-2xl font-bold bg-gradient-to-r from-orange-400 to-orange-500 text-white">Siguiente ▶</button>
            <button id="downloadBtn" class="w-full py-3 rounded-2xl font-bold bg-gradient-to-r from-orange-400 to-orange-500 text-white">Descargar actual</button>
            <button id="downloadAllBtn" class="w-full py-3 rounded-2xl font-bold bg-gradient-to-r from-green-400 to-green-500 text-white">Descargar todo (ZIP)</button>
          </div>

          <p class="text-xs text-zinc-500 mt-2">Consejo: guarda el CSV en UTF-8. Si la fuente tarda en cargar, espera 0.5s antes de descargar.</p>
        </div>

        <!-- Vista previa (derecha) -->
        <div class="space-y-4">
          <div class="canvas-border">
            <canvas id="preview" width="800" height="450"></canvas>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <div class="text-sm text-zinc-600">Entrada CSV (primeras 50 líneas):</div>
              <div id="csvList" class="mt-2 max-h-48 overflow-auto rounded-xl border border-zinc-100 p-3 bg-white"></div>
            </div>

            <div>
              <div class="text-sm text-zinc-600">Datos actuales</div>
              <div class="mt-2 rounded-xl border border-zinc-100 p-3 bg-white">
                <div><strong>Índice:</strong> <span id="idx">-</span></div>
                <div><strong>Nombre:</strong> <span id="curName">-</span></div>
                <div><strong>Equipo:</strong> <span id="curTeam">-</span></div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- footer compacto -->
    <section class="mt-10 text-center">
      <p class="text-xs text-zinc-500">© <span id="year"></span> Club de Debate UMU</p>
    </section>
  </main>

  <!-- botón vuelta -->
  <a href="./index.html" class="btn-fixed bg-white/90 backdrop-blur px-4 py-3 rounded-full shadow-lg border border-zinc-200 text-sm font-semibold hover:scale-105 transition-transform">← Página principal</a>

  <script>
    // ---------------------------
    // Inicialización visual
    // ---------------------------
    document.getElementById('year').textContent = new Date().getFullYear();

    // ---------------------------
    // Estado de la aplicación
    // ---------------------------
    let participants = [];          // array de objetos {name, team}
    let current = 0;                // índice actual
    let img = new Image();          // imagen base cargada
    let imgLoaded = false;          // flag de imagen cargada

    // Elementos DOM
    const canvas = document.getElementById('preview');
    const ctx = canvas.getContext('2d');

    const imgInput = document.getElementById('imgInput');
    const csvInput = document.getElementById('csvInput');
    const imgDrop = document.getElementById('imgDropzone');
    const csvDrop = document.getElementById('csvDropzone');
    const imgName = document.getElementById('imgName');
    const csvName = document.getElementById('csvName');

    const csvList = document.getElementById('csvList');
    const fontSize = document.getElementById('fontSize');
    const fontSizeVal = document.getElementById('fontSizeVal');
    const fontFamily = document.getElementById('fontFamily');
    const fontColor = document.getElementById('fontColor');
    const positionPreset = document.getElementById('positionPreset');
    const clickToPlace = document.getElementById('clickToPlace');

    const idxEl = document.getElementById('idx');
    const curName = document.getElementById('curName');
    const curTeam = document.getElementById('curTeam');

    // posición por defecto (porcentual)
    let textPos = { xPct: 50, yPct: 85 };

    // ---------------------------
    // Función auxiliar: configurar dropzones (arrastrar/soltar)
    // ---------------------------
    function setupDropzone(dropEl, inputEl, onFile) {
      dropEl.addEventListener('click', ()=> inputEl.click());
      dropEl.addEventListener('dragover', (e)=>{ e.preventDefault(); dropEl.classList.add('dragover'); });
      dropEl.addEventListener('dragleave', (e)=>{ e.preventDefault(); dropEl.classList.remove('dragover'); });
      dropEl.addEventListener('drop', (e)=>{ e.preventDefault(); dropEl.classList.remove('dragover'); const f = e.dataTransfer.files[0]; if(f) inputEl.files = e.dataTransfer.files; onFile(f); });
      inputEl.addEventListener('change', ()=>{ const f = inputEl.files[0]; onFile(f); });
    }

    // ---------------------------
    // Carga de imagen (dropzone)
    // ---------------------------
    setupDropzone(imgDrop, imgInput, (f)=>{
      if(!f) return;
      imgName.textContent = f.name;
      const url = URL.createObjectURL(f);
      img.onload = ()=>{
        // esperar a que las fuentes web estén listas para que se renderice con la tipografía correcta
        document.fonts.ready.then(()=>{
          imgLoaded=true; fitCanvasToImage(); render(true); URL.revokeObjectURL(url);
        });
      };
      img.src = url;
    });

    // ---------------------------
    // Carga de CSV (dropzone)
    // ---------------------------
    setupDropzone(csvDrop, csvInput, (f)=>{
      if(!f) return;
      csvName.textContent = f.name;
      const reader = new FileReader();
      reader.onload = ()=>{
        parseCSV(reader.result);
        showList();
        document.fonts.ready.then(()=>render(true));
      };
      reader.readAsText(f, 'utf-8');
    });

    // ---------------------------
    // Control de tamaño de fuente (slider)
    // ---------------------------
    if(fontSize){
      fontSize.addEventListener('input', ()=>{ fontSizeVal.textContent = fontSize.value; render(true); });
    }

    fontFamily.addEventListener('change', ()=>{ document.fonts.ready.then(()=>render(true)); });
    fontColor.addEventListener('change', ()=>render(true));
    positionPreset.addEventListener('change', ()=>{
      const [x,y] = positionPreset.value.split(',').map(v=>Number(v));
      textPos.xPct = x; textPos.yPct = y; render(true);
    });

    // ---------------------------
    // Navegación y descargas
    // ---------------------------
    document.getElementById('prevBtn').addEventListener('click', ()=>{ if(participants.length===0) return; current=(current-1+participants.length)%participants.length; updateCurrentUI(); render(true); });
    document.getElementById('nextBtn').addEventListener('click', ()=>{ if(participants.length===0) return; current=(current+1)%participants.length; updateCurrentUI(); render(true); });

    document.getElementById('downloadBtn').addEventListener('click', async ()=>{
      if(!imgLoaded || participants.length===0) return alert('Necesitas imagen y CSV con al menos una línea');
      await exportCurrentImage();
    });

    document.getElementById('downloadAllBtn').addEventListener('click', async ()=>{
      if(!imgLoaded || participants.length===0) return alert('Necesitas imagen y CSV con al menos una línea');
      await exportAllZip();
    });

    // ---------------------------
    // Clic en canvas para posicionar (tiene en cuenta el escalado CSS)
    // ---------------------------
    canvas.addEventListener('click', e=>{
      if(!clickToPlace.checked) return;
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const x = (e.clientX - rect.left) * scaleX;
      const y = (e.clientY - rect.top) * scaleY;
      textPos.xPct = Math.round(100 * x / canvas.width);
      textPos.yPct = Math.round(100 * y / canvas.height);
      positionPreset.value = `${textPos.xPct},${textPos.yPct}`;
      render(true);
    });

    // ---------------------------
    // Parsear CSV: separador ';'
    // ---------------------------
    function parseCSV(text){
      participants = [];
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length>0);
      for(const line of lines){
        const parts = line.split(';');
        if(parts.length===0) continue;
        const name = parts[0].trim();
        const team = (parts[1]||'').trim();
        participants.push({name, team});
      }
      current = 0;
      updateCurrentUI();
    }

    // ---------------------------
    // Mostrar lista (vista previa)
    // ---------------------------
    function showList(){
      csvList.innerHTML = '';
      const max = Math.min(50, participants.length);
      for(let i=0;i<max;i++){
        const p = participants[i];
        const div = document.createElement('div');
        div.textContent = `${i+1}. ${p.name}${p.team ? ' — ' + p.team : ''}`;
        if(i===current) div.style.background = '#f7faff';
        div.className = 'py-1';
        csvList.appendChild(div);
      }
      if(participants.length>50){
        const more = document.createElement('div'); more.className='small-muted'; more.textContent = `... (${participants.length-50} más)`; csvList.appendChild(more);
      }
    }

    // ---------------------------
    // Actualizar UI de participante actual
    // ---------------------------
    function updateCurrentUI(){
      idxEl.textContent = participants.length? (current+1) + '/' + participants.length : '-';
      curName.textContent = participants.length? participants[current].name : '-';
      curTeam.textContent = participants.length? participants[current].team : '-';
      showList();
    }

    // ---------------------------
    // Ajustar tamaño del canvas según la imagen (mantener máximo)
    // ---------------------------
    function fitCanvasToImage(){
      const maxW = 1200;
      const scale = Math.min(1, maxW / img.width);
      canvas.width = Math.round(img.width * scale);
      canvas.height = Math.round(img.height * scale);
    }

    // ---------------------------
    // Renderizado: dibuja imagen + texto en canvas
    // - showMarker: si true muestra el marcador rojo en la vista (NO se exporta si passamos false)
    // - NO se usa strokeText (sin borde). En su lugar usamos una sombra suave para legibilidad.
    // ---------------------------
    function render(showMarker = true){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if(imgLoaded){
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      } else {
        ctx.fillStyle = '#f3f4f6';
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = '#475569';
        ctx.font = '18px Inter, sans-serif';
        ctx.fillText('Sube una imagen para vista previa', 20, 40);
      }

      if(participants.length===0) return;

      const p = participants[current];
      const nameText = p.name;
      const teamText = p.team;
      const fsize = Number((fontSize && fontSize.value) || 36);
      const family = (fontFamily && fontFamily.value) || 'Inter';
      const color = (fontColor && fontColor.value) || '#ffffff';
      const familySafe = family.replace(/"/g, '');

      // estilos de texto: sin borde, con sombra suave para contraste
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = color;
      ctx.shadowColor = 'rgba(0,0,0,0.45)';
      ctx.shadowBlur = Math.max(2, Math.round(fsize/12));

      const x = canvas.width * textPos.xPct / 100;
      const y = canvas.height * textPos.yPct / 100;

      ctx.font = `bold ${fsize}px "${familySafe}", sans-serif`;
      ctx.fillText(nameText, x, y - (fsize * 0.22));

      ctx.font = `normal ${Math.round(fsize * 0.6)}px "${familySafe}", sans-serif`;
      ctx.fillText(teamText, x, y + (fsize * 0.6));

      // desactivar sombra para otros elementos
      ctx.shadowBlur = 0;

      // marcador UI (solo en vista)
      if(showMarker && clickToPlace && clickToPlace.checked){
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, Math.PI*2);
        ctx.fillStyle = 'rgba(255,99,71,0.95)';
        ctx.fill();
      }
    }

    // ---------------------------
    // Exportar imagen actual (sin marcador UI)
    // ---------------------------
    async function exportCurrentImage(){
      render(false); // sin marcador
      await new Promise(r => setTimeout(r, 80)); // dejar que se repinte
      canvas.toBlob(blob=>{
        const p = participants[current];
        const safeName = sanitizeFilename((p.name || 'participante') + ' - ' + (p.team||'equipo'));
        const a = document.createElement('a');
        const url = URL.createObjectURL(blob);
        a.href = url; a.download = safeName + '.png';
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
        // restaurar vista con marcador
        render(true);
      }, 'image/png');
    }

    // ---------------------------
    // Exportar todas las imágenes en ZIP (usa JSZip bajo demanda)
    // ---------------------------
    async function exportAllZip(){
      if(typeof JSZip === 'undefined'){
        try{ await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js'); }catch(e){ alert('No se pudo cargar JSZip'); return; }
      }
      const zip = new JSZip();
      const folder = zip.folder('participantes');
      const initialIndex = current;
      for(let i=0;i<participants.length;i++){
        current = i; updateCurrentUI();
        render(false);
        await new Promise(r => setTimeout(r, 80));
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
        const p = participants[i];
        const fname = sanitizeFilename((i+1) + ' - ' + (p.name||'participante') + ' - ' + (p.team||'equipo') + '.png');
        folder.file(fname, blob);
      }
      current = initialIndex; updateCurrentUI(); render(true);
      const content = await zip.generateAsync({type:'blob'});
      const a = document.createElement('a');
      const url = URL.createObjectURL(content);
      a.href = url; a.download = 'imagenes_participantes.zip';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    // ---------------------------
    // Utilidades
    // ---------------------------
    function sanitizeFilename(name){
      return name.replace(/[\\\/:*?"<>|]/g,'').replace(/\s+/g,' ').trim();
    }
    function loadScript(src){
      return new Promise((resolve,reject)=>{
        const s=document.createElement('script'); s.src = src; s.onload = resolve; s.onerror = reject; document.head.appendChild(s);
      });
    }

    // ---------------------------
    // Inicializar canvas y primer render
    // ---------------------------
    canvas.width = 800; canvas.height = 450;
    document.fonts.ready.then(()=>{ render(true); });

  </script>
</body>
</html>
